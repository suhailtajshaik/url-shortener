<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>URL Shortener - Modern & Simple</title>

  <!-- Inter Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f7f6f3;
      --bg-tertiary: #f1f0ed;
      --bg-hover: #ececea;

      --text-primary: #37352f;
      --text-secondary: #787774;
      --text-tertiary: #9b9a97;

      --border-default: #e3e2df;
      --border-hover: #d3d2ce;

      --accent-blue: #0b6bcb;
      --accent-blue-light: #edf5ff;
      --accent-green: #0d9488;
      --accent-green-light: #f0fdfa;
      --accent-red: #dc2626;
      --accent-red-light: #fef2f2;

      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
      --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.12);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-secondary);
      color: var(--text-primary);
      line-height: 1.6;
      font-size: 14px;
    }

    /* Layout */
    .app-container {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background: var(--bg-primary);
      border-right: 1px solid var(--border-default);
      padding: 24px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      margin-bottom: 16px;
    }

    .logo-icon {
      font-size: 24px;
    }

    .logo-text {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.15s;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      user-select: none;
    }

    .nav-item:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .nav-item.active {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .nav-icon {
      font-size: 18px;
      width: 20px;
      text-align: center;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      overflow-y: auto;
    }

    .page {
      display: none;
      max-width: 900px;
      margin: 0 auto;
      padding: 60px 40px;
    }

    .page.active {
      display: block;
    }

    .page-header {
      margin-bottom: 32px;
    }

    .page-title {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .page-subtitle {
      font-size: 15px;
      color: var(--text-secondary);
    }

    /* Cards */
    .card {
      background: var(--bg-primary);
      border: 1px solid var(--border-default);
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 16px;
      box-shadow: var(--shadow-sm);
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 16px;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .form-hint {
      font-size: 12px;
      color: var(--text-tertiary);
      margin-top: 4px;
    }

    .input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border-default);
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      background: var(--bg-primary);
      color: var(--text-primary);
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    .input:hover {
      border-color: var(--border-hover);
    }

    .input:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 3px var(--accent-blue-light);
    }

    .input::placeholder {
      color: var(--text-tertiary);
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checkbox {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .checkbox-label {
      font-size: 14px;
      color: var(--text-secondary);
      cursor: pointer;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.15s;
      border: none;
      user-select: none;
    }

    .btn-primary {
      background: var(--accent-blue);
      color: white;
    }

    .btn-primary:hover {
      background: #0a5fba;
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      background: var(--bg-hover);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
    }

    .btn-ghost:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .btn-danger {
      background: var(--accent-red);
      color: white;
    }

    .btn-danger:hover {
      background: #b91c1c;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
    }

    /* Alert */
    .alert {
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 20px;
      display: none;
      font-size: 14px;
    }

    .alert.show {
      display: block;
    }

    .alert-success {
      background: var(--accent-green-light);
      color: var(--accent-green);
      border: 1px solid #a7f3d0;
    }

    .alert-error {
      background: var(--accent-red-light);
      color: var(--accent-red);
      border: 1px solid #fecaca;
    }

    /* Result Box */
    .result-box {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-default);
      border-radius: 8px;
      padding: 16px;
      margin-top: 24px;
      display: none;
    }

    .result-box.show {
      display: block;
    }

    .result-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .result-url {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px;
      background: var(--bg-primary);
      border: 1px solid var(--border-default);
      border-radius: 6px;
      margin-bottom: 12px;
    }

    .result-url-text {
      font-size: 16px;
      font-weight: 500;
      color: var(--accent-blue);
      word-break: break-all;
    }

    .qr-container {
      text-align: center;
      padding: 16px;
      background: var(--bg-primary);
      border: 1px solid var(--border-default);
      border-radius: 6px;
    }

    .qr-image {
      max-width: 200px;
      border-radius: 4px;
      margin-bottom: 12px;
    }

    /* Table */
    .table-container {
      background: var(--bg-primary);
      border: 1px solid var(--border-default);
      border-radius: 8px;
      overflow: hidden;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
    }

    .table thead {
      background: var(--bg-tertiary);
    }

    .table th {
      padding: 12px 16px;
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border-default);
    }

    .table td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-default);
      font-size: 14px;
      color: var(--text-primary);
    }

    .table tbody tr:hover {
      background: var(--bg-tertiary);
    }

    .table tbody tr:last-child td {
      border-bottom: none;
    }

    .url-cell {
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: var(--accent-blue);
      cursor: pointer;
    }

    .url-cell:hover {
      text-decoration: underline;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .badge-custom {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-auto {
      background: #dbeafe;
      color: #1e40af;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
    }

    .icon-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: background 0.15s;
      font-size: 16px;
    }

    .icon-btn:hover {
      background: var(--bg-hover);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    .empty-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .empty-text {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* Loading Spinner */
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--bg-primary);
      border: 1px solid var(--border-default);
      border-radius: 8px;
      padding: 20px;
      box-shadow: var(--shadow-sm);
    }

    .stat-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary);
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: var(--bg-primary);
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-default);
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .modal-body {
      padding: 24px;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border-default);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .app-container {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--border-default);
        padding: 16px;
      }

      .page {
        padding: 32px 20px;
      }

      .page-title {
        font-size: 24px;
      }

      .table-container {
        overflow-x: auto;
      }
    }

    /* Utilities */
    .text-center {
      text-align: center;
    }

    .mt-2 {
      margin-top: 16px;
    }

    .mb-2 {
      margin-bottom: 16px;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo">
        <span class="logo-icon">üîó</span>
        <span class="logo-text">URL Shortener</span>
      </div>

      <nav>
        <div class="nav-item active" onclick="showPage('create')">
          <span class="nav-icon">‚ú®</span>
          <span>Create Short URL</span>
        </div>
        <div class="nav-item" onclick="showPage('my-urls')">
          <span class="nav-icon">üìã</span>
          <span>My URLs</span>
        </div>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Create Page -->
      <div id="create-page" class="page active">
        <div class="page-header">
          <h1 class="page-title">Create Short URL</h1>
          <p class="page-subtitle">Shorten your long URLs and generate QR codes instantly</p>
        </div>

        <div class="alert alert-error" id="createError"></div>
        <div class="alert alert-success" id="createSuccess"></div>

        <div class="card">
          <form id="createForm">
            <div class="form-group">
              <label class="form-label" for="longUrl">Long URL *</label>
              <input
                type="url"
                id="longUrl"
                class="input"
                placeholder="https://example.com/your-very-long-url"
                required
              >
            </div>

            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="useCustomCode" class="checkbox" onchange="toggleCustomCode()">
                <label for="useCustomCode" class="checkbox-label">Use custom short code</label>
              </div>
            </div>

            <div class="form-group hidden" id="customCodeGroup">
              <label class="form-label" for="customCode">Custom Short Code</label>
              <input
                type="text"
                id="customCode"
                class="input"
                placeholder="my-custom-code"
                pattern="[a-zA-Z0-9_-]{3,30}"
              >
              <div class="form-hint">3-30 characters: letters, numbers, hyphens, and underscores only</div>
            </div>

            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="useExpiration" class="checkbox" onchange="toggleExpiration()">
                <label for="useExpiration" class="checkbox-label">Set expiration time</label>
              </div>
            </div>

            <div class="form-group hidden" id="expirationGroup">
              <label class="form-label" for="expiresIn">Expires In (hours)</label>
              <input
                type="number"
                id="expiresIn"
                class="input"
                placeholder="720"
                min="1"
                max="8760"
              >
              <div class="form-hint">Maximum 8760 hours (1 year)</div>
            </div>

            <button type="submit" class="btn btn-primary" id="createBtn">
              <span id="createBtnText">Create Short URL</span>
            </button>
          </form>
        </div>

        <!-- Result Section -->
        <div class="result-box" id="resultBox">
          <div class="result-label">Your Short URL</div>
          <div class="result-url">
            <span class="result-url-text" id="shortUrlDisplay"></span>
            <button type="button" class="btn btn-sm btn-secondary" onclick="copyShortUrl()">
              <span id="copyBtnText">Copy</span>
            </button>
          </div>

          <div class="qr-container">
            <img id="qrCode" class="qr-image" alt="QR Code">
            <div>
              <button type="button" class="btn btn-sm btn-secondary" onclick="downloadQR()">
                üì• Download QR Code
              </button>
            </div>
          </div>

          <div style="margin-top: 16px; text-align: center;">
            <button type="button" class="btn btn-sm btn-ghost" onclick="createAnother()">
              Create Another URL
            </button>
          </div>
        </div>
      </div>

      <!-- My URLs Page -->
      <div id="my-urls-page" class="page">
        <div class="page-header">
          <h1 class="page-title">My URLs</h1>
          <p class="page-subtitle">Manage and track all your shortened URLs</p>
        </div>

        <div id="urlsTableContainer">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>
    </main>
  </div>

  <!-- Edit Modal -->
  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Edit URL Destination</h2>
      </div>
      <div class="modal-body">
        <div class="alert alert-error" id="editError"></div>

        <div class="form-group">
          <label class="form-label">Short Code</label>
          <input type="text" id="editUrlCode" class="input" disabled>
        </div>

        <div class="form-group">
          <label class="form-label" for="editLongUrl">New Destination URL *</label>
          <input type="url" id="editLongUrl" class="input" required>
        </div>

        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="editResetExpiration" class="checkbox" checked>
            <label for="editResetExpiration" class="checkbox-label">Reset expiration timer</label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-ghost" onclick="closeEditModal()">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveEdit()">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Analytics Modal -->
  <div class="modal-overlay" id="analyticsModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">URL Analytics</h2>
      </div>
      <div class="modal-body" id="analyticsContent">
        <!-- Will be populated by JavaScript -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-ghost" onclick="closeAnalyticsModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- QR Modal -->
  <div class="modal-overlay" id="qrModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">QR Code</h2>
      </div>
      <div class="modal-body text-center">
        <img id="qrModalImage" class="qr-image" alt="QR Code" style="max-width: 300px;">
        <div style="margin-top: 16px;">
          <button type="button" class="btn btn-secondary" onclick="downloadModalQR()">
            üì• Download QR Code
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-ghost" onclick="closeQRModal()">Close</button>
      </div>
    </div>
  </div>

  <script>
    // State
    let currentUrlCode = null;
    let currentQRData = null;
    let allUrls = [];

    // Page Navigation
    function showPage(pageName) {
      document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));

      const pageId = pageName === 'create' ? 'create-page' : 'my-urls-page';
      document.getElementById(pageId).classList.add('active');

      event.target.closest('.nav-item').classList.add('active');

      if (pageName === 'my-urls') {
        loadAllUrls();
      }
    }

    // Toggle Functions
    function toggleCustomCode() {
      const checkbox = document.getElementById('useCustomCode');
      const group = document.getElementById('customCodeGroup');
      const input = document.getElementById('customCode');

      if (checkbox.checked) {
        group.classList.remove('hidden');
        input.required = true;
      } else {
        group.classList.add('hidden');
        input.required = false;
        input.value = '';
      }
    }

    function toggleExpiration() {
      const checkbox = document.getElementById('useExpiration');
      const group = document.getElementById('expirationGroup');
      const input = document.getElementById('expiresIn');

      if (checkbox.checked) {
        group.classList.remove('hidden');
        input.required = true;
      } else {
        group.classList.add('hidden');
        input.required = false;
        input.value = '';
      }
    }

    // Create URL Form
    document.getElementById('createForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const longUrl = document.getElementById('longUrl').value.trim();
      const customCode = document.getElementById('useCustomCode').checked
        ? document.getElementById('customCode').value.trim()
        : null;
      const expiresIn = document.getElementById('useExpiration').checked
        ? parseInt(document.getElementById('expiresIn').value)
        : null;

      const createBtn = document.getElementById('createBtn');
      const btnText = document.getElementById('createBtnText');

      // Reset alerts
      hideAlert('createError');
      hideAlert('createSuccess');
      document.getElementById('resultBox').classList.remove('show');

      // Loading state
      createBtn.disabled = true;
      btnText.innerHTML = '<span class="loading"></span> Creating...';

      try {
        const body = { longUrl };
        if (customCode) body.customCode = customCode;
        if (expiresIn) body.expiresIn = expiresIn;

        const response = await fetch('/api/url/shorten', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const data = await response.json();

        if (!response.ok || !data.success) {
          throw new Error(data.message || data.errors?.join(', ') || 'Failed to create short URL');
        }

        // Success
        currentUrlCode = data.data.urlCode;
        document.getElementById('shortUrlDisplay').textContent = data.data.shortUrl;

        // Load QR code
        await loadQRCode(currentUrlCode);

        // Show result
        document.getElementById('resultBox').classList.add('show');
        showAlert('createSuccess', data.message || 'Short URL created successfully!');

        // Scroll to result
        document.getElementById('resultBox').scrollIntoView({ behavior: 'smooth', block: 'nearest' });

      } catch (error) {
        console.error('Error:', error);
        showAlert('createError', error.message);
      } finally {
        createBtn.disabled = false;
        btnText.textContent = 'Create Short URL';
      }
    });

    // Load QR Code
    async function loadQRCode(urlCode) {
      try {
        const response = await fetch(`/api/url/qrcode/${urlCode}`);
        const data = await response.json();

        if (response.ok && data.success) {
          document.getElementById('qrCode').src = data.data.qrCode;
          currentQRData = data.data.qrCode;
        }
      } catch (error) {
        console.error('Error loading QR code:', error);
      }
    }

    // Copy Short URL
    function copyShortUrl() {
      const shortUrl = document.getElementById('shortUrlDisplay').textContent;
      const btnText = document.getElementById('copyBtnText');

      navigator.clipboard.writeText(shortUrl).then(() => {
        btnText.textContent = '‚úì Copied!';
        setTimeout(() => {
          btnText.textContent = 'Copy';
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy:', err);
      });
    }

    // Download QR Code
    function downloadQR() {
      if (!currentQRData || !currentUrlCode) return;

      const link = document.createElement('a');
      link.href = currentQRData;
      link.download = `qr-code-${currentUrlCode}.png`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Create Another URL
    function createAnother() {
      document.getElementById('createForm').reset();
      document.getElementById('resultBox').classList.remove('show');
      document.getElementById('customCodeGroup').classList.add('hidden');
      document.getElementById('expirationGroup').classList.add('hidden');
      hideAlert('createError');
      hideAlert('createSuccess');
      document.getElementById('longUrl').focus();
    }

    // Load All URLs
    async function loadAllUrls() {
      const container = document.getElementById('urlsTableContainer');

      // For now, we'll use localStorage to store URLs since there's no "list all" endpoint
      // In a production app, you'd want a backend endpoint for this
      const storedUrls = JSON.parse(localStorage.getItem('myUrls') || '[]');

      if (storedUrls.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üîó</div>
            <div class="empty-title">No URLs yet</div>
            <div class="empty-text">Create your first short URL to get started</div>
            <button class="btn btn-primary mt-2" onclick="showPage('create'); event.stopPropagation()">
              Create Short URL
            </button>
          </div>
        `;
        return;
      }

      // Fetch details for each URL
      const urlDetails = await Promise.all(
        storedUrls.map(async (urlCode) => {
          try {
            const response = await fetch(`/api/url/details/${urlCode}`);
            const data = await response.json();
            return data.success ? data.data : null;
          } catch (error) {
            console.error(`Error loading ${urlCode}:`, error);
            return null;
          }
        })
      );

      allUrls = urlDetails.filter(url => url !== null);

      // Render table
      container.innerHTML = `
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Short Code</th>
                <th>Destination URL</th>
                <th>Clicks</th>
                <th>Type</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${allUrls.map(url => `
                <tr>
                  <td>
                    <span class="url-cell" onclick="window.open('${url.shortUrl}', '_blank')">
                      ${url.urlCode}
                    </span>
                  </td>
                  <td>
                    <span class="url-cell" title="${url.longUrl}">
                      ${url.longUrl}
                    </span>
                  </td>
                  <td>${url.totalClicks || 0}</td>
                  <td>
                    <span class="badge ${url.isCustom ? 'badge-custom' : 'badge-auto'}">
                      ${url.isCustom ? 'Custom' : 'Auto'}
                    </span>
                  </td>
                  <td>${new Date(url.createdAt).toLocaleDateString()}</td>
                  <td>
                    <div class="action-buttons">
                      <button class="icon-btn" onclick="viewAnalytics('${url.urlCode}')" title="Analytics">
                        üìä
                      </button>
                      <button class="icon-btn" onclick="viewQR('${url.urlCode}')" title="QR Code">
                        üì±
                      </button>
                      <button class="icon-btn" onclick="editUrl('${url.urlCode}', '${url.longUrl.replace(/'/g, "\\'")}')" title="Edit">
                        ‚úèÔ∏è
                      </button>
                      <button class="icon-btn" onclick="deleteUrl('${url.urlCode}')" title="Delete">
                        üóëÔ∏è
                      </button>
                    </div>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    // Store URL in localStorage when created
    const originalFetch = window.fetch;
    window.fetch = async function(...args) {
      const response = await originalFetch.apply(this, args);

      if (args[0] === '/api/url/shorten' && args[1]?.method === 'POST') {
        const clone = response.clone();
        const data = await clone.json();

        if (data.success && data.data.urlCode) {
          const storedUrls = JSON.parse(localStorage.getItem('myUrls') || '[]');
          if (!storedUrls.includes(data.data.urlCode)) {
            storedUrls.unshift(data.data.urlCode);
            localStorage.setItem('myUrls', JSON.stringify(storedUrls));
          }
        }
      }

      return response;
    };

    // Edit URL
    let currentEditUrlCode = null;

    function editUrl(urlCode, longUrl) {
      currentEditUrlCode = urlCode;
      document.getElementById('editUrlCode').value = urlCode;
      document.getElementById('editLongUrl').value = longUrl;
      document.getElementById('editResetExpiration').checked = true;
      hideAlert('editError');
      document.getElementById('editModal').classList.add('show');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('show');
      currentEditUrlCode = null;
    }

    async function saveEdit() {
      if (!currentEditUrlCode) return;

      const longUrl = document.getElementById('editLongUrl').value.trim();
      const resetExpiration = document.getElementById('editResetExpiration').checked;

      hideAlert('editError');

      try {
        const response = await fetch(`/api/url/edit/${currentEditUrlCode}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ longUrl, resetExpiration })
        });

        const data = await response.json();

        if (!response.ok || !data.success) {
          throw new Error(data.message || data.errors?.join(', ') || 'Failed to update URL');
        }

        closeEditModal();
        loadAllUrls();

      } catch (error) {
        console.error('Error:', error);
        showAlert('editError', error.message);
      }
    }

    // Delete URL
    async function deleteUrl(urlCode) {
      if (!confirm(`Are you sure you want to delete the short URL "${urlCode}"? This action cannot be undone.`)) {
        return;
      }

      try {
        const response = await fetch(`/api/url/${urlCode}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (!response.ok || !data.success) {
          throw new Error(data.message || 'Failed to delete URL');
        }

        // Remove from localStorage
        const storedUrls = JSON.parse(localStorage.getItem('myUrls') || '[]');
        const index = storedUrls.indexOf(urlCode);
        if (index > -1) {
          storedUrls.splice(index, 1);
          localStorage.setItem('myUrls', JSON.stringify(storedUrls));
        }

        loadAllUrls();

      } catch (error) {
        console.error('Error:', error);
        alert(error.message);
      }
    }

    // View Analytics
    async function viewAnalytics(urlCode) {
      try {
        const response = await fetch(`/api/url/stats/${urlCode}`);
        const data = await response.json();

        if (!response.ok || !data.success) {
          throw new Error(data.message || 'Failed to load analytics');
        }

        const stats = data.data;

        document.getElementById('analyticsContent').innerHTML = `
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Total Clicks</div>
              <div class="stat-value">${stats.totalClicks}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">With Location</div>
              <div class="stat-value">${stats.clicksWithLocation}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Location Rate</div>
              <div class="stat-value">${stats.locationPermissionRate}</div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Short URL</label>
            <div class="result-url">
              <span class="result-url-text">${stats.shortUrl}</span>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Destination URL</label>
            <div style="word-break: break-all; color: var(--text-secondary);">
              ${stats.longUrl}
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Created</label>
            <div>${new Date(stats.createdAt).toLocaleString()}</div>
          </div>

          ${stats.lastClickedAt ? `
            <div class="form-group">
              <label class="form-label">Last Clicked</label>
              <div>${new Date(stats.lastClickedAt).toLocaleString()}</div>
            </div>
          ` : ''}

          ${stats.recentClicks && stats.recentClicks.length > 0 ? `
            <div class="form-group">
              <label class="form-label">Recent Clicks (Last 10)</label>
              <div style="max-height: 200px; overflow-y: auto;">
                ${stats.recentClicks.map(click => `
                  <div style="padding: 8px; border-bottom: 1px solid var(--border-default); font-size: 12px;">
                    <div><strong>${new Date(click.timestamp).toLocaleString()}</strong></div>
                    <div style="color: var(--text-secondary);">
                      ${click.location?.permissionGranted ?
                        `üìç ${click.location.latitude.toFixed(4)}, ${click.location.longitude.toFixed(4)}` :
                        'üìç Location not available'}
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
        `;

        document.getElementById('analyticsModal').classList.add('show');

      } catch (error) {
        console.error('Error:', error);
        alert(error.message);
      }
    }

    function closeAnalyticsModal() {
      document.getElementById('analyticsModal').classList.remove('show');
    }

    // View QR Code
    let currentModalQRData = null;
    let currentModalUrlCode = null;

    async function viewQR(urlCode) {
      try {
        const response = await fetch(`/api/url/qrcode/${urlCode}`);
        const data = await response.json();

        if (!response.ok || !data.success) {
          throw new Error(data.message || 'Failed to load QR code');
        }

        currentModalQRData = data.data.qrCode;
        currentModalUrlCode = urlCode;
        document.getElementById('qrModalImage').src = data.data.qrCode;
        document.getElementById('qrModal').classList.add('show');

      } catch (error) {
        console.error('Error:', error);
        alert(error.message);
      }
    }

    function closeQRModal() {
      document.getElementById('qrModal').classList.remove('show');
    }

    function downloadModalQR() {
      if (!currentModalQRData || !currentModalUrlCode) return;

      const link = document.createElement('a');
      link.href = currentModalQRData;
      link.download = `qr-code-${currentModalUrlCode}.png`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Alert Helpers
    function showAlert(id, message) {
      const alert = document.getElementById(id);
      alert.textContent = message;
      alert.classList.add('show');
    }

    function hideAlert(id) {
      document.getElementById(id).classList.remove('show');
    }

    // Close modals on overlay click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('show');
        }
      });
    });
  </script>
</body>
</html>
